{% extends "base.html" %}
{% load static %}

{% block content %}
  <style>
    /* Accessibility improvements */
    button {
      min-height: 48px; /* WCAG 2.5 minimum touch target size */
      font-size: clamp(16px, 5vw, 24px);
    }
    
    .text-3xl, .text-4xl, .text-5xl {
      font-size: clamp(24px, 6vw, 48px);
      line-height: 1.2;
    }
    
    .text-lg {
      font-size: clamp(16px, 4vw, 20px);
      line-height: 1.6;
    }
    
    .text-sm {
      font-size: clamp(14px, 3vw, 16px);
      line-height: 1.6;
    }
    
    /* Better focus indicators for keyboard navigation */
    button:focus-visible,
    a:focus-visible {
      outline: 3px solid #2563eb;
      outline-offset: 2px;
    }
    
    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>

  {% csrf_token %}

  <div class="max-w-4xl mx-auto">
    <!-- Header Hero - Simplified -->
    <section class="bg-white border-b border-gray-200 px-4 py-6 -mx-4 sm:-mx-6 lg:-mx-8 mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold text-gray-900 mb-2">Notificaciones Push</h1>
      <p class="text-base text-gray-600">Gestiona tus alertas</p>
    </section>

    <!-- Aviso para TWA/App instalada - se muestra din√°micamente -->
    <div id="twa-info-banner" class="hidden mx-4 mb-4 bg-purple-50 border-2 border-purple-200 rounded-xl p-4">
      <div class="flex items-start gap-3">
        <iconify-icon icon="lucide:smartphone" class="text-2xl text-purple-600 flex-shrink-0 mt-0.5"></iconify-icon>
        <div>
          <h3 class="font-bold text-purple-900 mb-1">App instalada detectada</h3>
          <p class="text-sm text-purple-800">Presiona "Habilitar notificaciones" para que Android te solicite permiso. Debes aceptar para recibir alertas.</p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-6 space-y-6">
      <!-- Status Card -->
      <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
        <div class="bg-blue-50 px-6 py-4 border-b-2 border-blue-200">
          <h2 class="text-lg font-bold text-gray-900">Estado</h2>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <p class="text-sm font-semibold text-gray-700 mb-2">Permisos:</p>
            <div id="permission-status" class="bg-gray-100 rounded-lg p-3 text-sm font-semibold">
              ‚è≥ Verificando...
            </div>
          </div>
          
          <div>
            <p class="text-sm font-semibold text-gray-700 mb-2">Suscripci√≥n:</p>
            <div id="subscription-status" class="bg-gray-100 rounded-lg p-3 text-sm font-semibold">
              ‚è≥ Verificando...
            </div>
          </div>
          
          <div>
            <p class="text-sm font-semibold text-gray-700 mb-2">Navegador:</p>
            <div id="browser-info" class="bg-gray-100 rounded-lg p-3 text-sm font-semibold">
              üîç Detectando...
            </div>
          </div>

          <!-- Entorno de ejecuci√≥n - visible solo en TWA/PWA -->
          <div id="environment-info-container" class="hidden">
            <p class="text-sm font-semibold text-gray-700 mb-2">Entorno:</p>
            <div id="environment-info" class="bg-gray-100 rounded-lg p-3 text-sm font-semibold">
              üîç Detectando...
            </div>
          </div>
        </div>
      </div>

      <!-- Actions Card -->
      <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
        <div class="bg-purple-50 px-6 py-4 border-b-2 border-purple-200">
          <h2 class="text-lg font-bold text-gray-900">Acciones</h2>
        </div>
        <div class="p-6 space-y-4">
          <!-- Solicitar permisos expl√≠citamente -->
          <button 
            id="permission-btn"
            onclick="handleRequestPermission()"
            class="w-full bg-white border-2 border-blue-600 hover:bg-blue-600 hover:text-white text-blue-700 font-semibold py-6 px-6 rounded-xl transition-all text-xl flex items-center justify-center gap-4 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Solicitar permisos de notificaciones"
          >
            <iconify-icon icon="lucide:shield-check" class="text-3xl"></iconify-icon>
            <span>Habilitar notificaciones</span>
          </button>

          <!-- Suscribirse -->
          <button 
            id="subscribe-btn" 
            onclick="handleSubscribe()"
            class="w-full bg-gray-900 hover:bg-gray-800 text-white font-semibold py-6 px-6 rounded-xl transition-all text-xl flex items-center justify-center gap-4 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Suscribirse para recibir notificaciones push">
            <iconify-icon icon="lucide:bell" class="text-3xl"></iconify-icon>
            <span>Suscribirse</span>
          </button>
          
          <!-- Enviar prueba -->
          <button 
            id="test-btn" 
            onclick="handleSendTest()"
            class="w-full bg-white border-2 border-gray-900 hover:bg-gray-900 hover:text-white text-gray-900 font-semibold py-6 px-6 rounded-xl transition-all text-xl flex items-center justify-center gap-4 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
            aria-label="Enviar una notificaci√≥n de prueba">
            <iconify-icon icon="lucide:send" class="text-3xl"></iconify-icon>
            <span>Enviar prueba</span>
          </button>
          
          <!-- Desuscribirse -->
          <button 
            id="unsubscribe-btn" 
            onclick="handleUnsubscribe()"
            class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-6 px-6 rounded-xl transition-all text-xl flex items-center justify-center gap-4 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
            aria-label="Desuscribirse de las notificaciones">
            <iconify-icon icon="lucide:bell-off" class="text-3xl"></iconify-icon>
            <span>Desuscribirse</span>
          </button>
        </div>
      </div>

      <!-- Instructions Card -->
      <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6">
        <h3 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
          <iconify-icon icon="lucide:info" class="text-2xl text-blue-600"></iconify-icon>
          C√≥mo funciona
        </h3>
        <ol class="space-y-2 text-sm text-blue-800 ml-8">
          <li><span class="font-bold">1.</span> Haz clic en "Suscribirse"</li>
          <li><span class="font-bold">2.</span> Acepta los permisos</li>
          <li><span class="font-bold">3.</span> Usa "Enviar prueba"</li>
          <li><span class="font-bold">4.</span> Recibe la notificaci√≥n</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    // Evitar redeclarar al volver a cargar el fragmento
    window.VAPID_PUBLIC_KEY = window.VAPID_PUBLIC_KEY || '{{ vapid_public_key }}';
    
    // Actualizar UI con el estado actual
    async function updateUI() {
      try {
        const status = await window.pushNotifications.checkStatus();

        // UI helper to avoid flicker when we already know the state
        const setSubscriptionUI = (subscribed) => {
          const subscriptionDiv = document.getElementById('subscription-status');
          if (subscribed) {
            subscriptionDiv.textContent = '‚úÖ Suscripci√≥n activa';
            subscriptionDiv.className = 'bg-green-100 text-green-900 rounded-lg p-3 text-sm font-semibold';
          } else {
            subscriptionDiv.textContent = '‚ùå No suscrito';
            subscriptionDiv.className = 'bg-gray-100 rounded-lg p-3 text-sm font-semibold';
          }
          document.getElementById('subscribe-btn').disabled = subscribed || !status.supported;
          document.getElementById('test-btn').disabled = !subscribed;
          document.getElementById('unsubscribe-btn').disabled = !subscribed;
        };
        
        // Actualizar estado de permisos
        const permissionDiv = document.getElementById('permission-status');
        const permissionBtn = document.getElementById('permission-btn');
        let permissionText = '';
        let permissionColor = '';
        
        switch(status.permission) {
          case 'granted':
            permissionText = '‚úÖ Permisos concedidos';
            permissionColor = 'bg-green-100 text-green-900';
            if (permissionBtn) permissionBtn.disabled = true;
            break;
          case 'denied':
            permissionText = '‚ùå Permisos denegados';
            permissionColor = 'bg-red-100 text-red-900';
            if (permissionBtn) permissionBtn.disabled = false;
            break;
          default:
            permissionText = '‚è≥ Permisos pendientes';
            permissionColor = 'bg-yellow-100 text-yellow-900';
            if (permissionBtn) permissionBtn.disabled = false;
        }
        
        permissionDiv.textContent = permissionText;
        permissionDiv.className = `${permissionColor} rounded-lg p-3 text-sm font-semibold`;
        
        // Actualizar estado de suscripci√≥n
        setSubscriptionUI(status.subscribed);
        
        // Actualizar info del navegador
        const browserDiv = document.getElementById('browser-info');
        const browserInfo = window.pushNotifications.getBrowserInfo();
        browserDiv.textContent = `${browserInfo} ${status.supported ? '‚úÖ' : '‚ùå'}`;
        browserDiv.className = status.supported ? 'bg-green-100 text-green-900 rounded-lg p-3 text-sm font-semibold' : 'bg-red-100 text-red-900 rounded-lg p-3 text-sm font-semibold';
        
        // Mantener consistencia con el helper
        setSubscriptionUI(status.subscribed);
        
      } catch (error) {
        console.error('Error al actualizar UI:', error);
      }
    }
    
    // Solicitar permisos manualmente
    async function handleRequestPermission() {
      mostrarMensaje('‚è≥ Solicitando permisos...', 'info');
      const granted = await solicitarPermisoNotificaciones();
      if (granted) {
        mostrarMensaje('‚úÖ Permisos concedidos', 'success');
      } else {
        mostrarMensaje('‚ùå Permiso no concedido', 'error');
      }
      await updateUI();
    }
    
    // Suscribirse a notificaciones
    async function handleSubscribe() {
      try {
        const permissionGranted = await solicitarPermisoNotificaciones();
        if (!permissionGranted) {
          mostrarMensaje('‚ùå Permisos denegados o bloqueados', 'error');
          return;
        }
        
        const subscription = await window.pushNotifications.subscribe(VAPID_PUBLIC_KEY);
        const result = await window.pushNotifications.register(subscription);

        // Reflejar inmediatamente el nuevo estado sin esperar relecturas del SW
        document.getElementById('subscription-status').textContent = '‚úÖ Suscripci√≥n activa';
        document.getElementById('subscription-status').className = 'bg-green-100 text-green-900 rounded-lg p-3 text-sm font-semibold';
        document.getElementById('subscribe-btn').disabled = true;
        document.getElementById('test-btn').disabled = false;
        document.getElementById('unsubscribe-btn').disabled = false;
        
        mostrarMensaje('‚úÖ ¬°Suscripci√≥n exitosa!', 'success');
        await updateUI();
        
      } catch (error) {
        console.error('Error al suscribirse:', error);
        mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
      }
    }
    
    // Enviar notificaci√≥n de prueba
    async function handleSendTest() {
      try {
        mostrarMensaje('üì§ Enviando...', 'info');
        const result = await window.pushNotifications.sendTest();
        mostrarMensaje(`‚úÖ Enviada a ${result.devices_count} dispositivo(s)`, 'success');
      } catch (error) {
        console.error('Error al enviar prueba:', error);
        mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
      }
    }
    
    // Desuscribirse
    async function handleUnsubscribe() {
      if (!confirm('¬øDesuscribirse de notificaciones?')) {
        return;
      }
      
      try {
        const unsubscribed = await window.pushNotifications.unsubscribe();
        if (unsubscribed) {
          mostrarMensaje('‚úÖ Desuscripci√≥n exitosa', 'success');
          await updateUI();
        }
      } catch (error) {
        console.error('Error al desuscribirse:', error);
        mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Mostrar informaci√≥n del entorno PWA/TWA
    function showEnvironmentInfo() {
      const banner = document.getElementById('twa-info-banner');
      const envContainer = document.getElementById('environment-info-container');
      const envInfo = document.getElementById('environment-info');
      
      if (typeof detectPWAEnvironment === 'function') {
        const env = detectPWAEnvironment();
        
        // Mostrar banner si es TWA o PWA instalada
        if (banner && (env.isTWA || env.isInstalled)) {
          banner.classList.remove('hidden');
        }
        
        // Mostrar informaci√≥n del entorno
        if (envContainer && envInfo && (env.isTWA || env.isInstalled)) {
          envContainer.classList.remove('hidden');
          
          let envText = '';
          let envClass = 'bg-gray-100 rounded-lg p-3 text-sm font-semibold';
          
          if (env.isTWA) {
            envText = 'üì± TWA (App desde Google Play)';
            envClass = 'bg-purple-100 text-purple-900 rounded-lg p-3 text-sm font-semibold';
          } else if (env.isInstalled) {
            envText = 'üì± PWA Instalada (' + env.displayMode + ')';
            envClass = 'bg-blue-100 text-blue-900 rounded-lg p-3 text-sm font-semibold';
          }
          
          envInfo.textContent = envText;
          envInfo.className = envClass;
        }
      }
    }
    
    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', async () => {
      // Mostrar informaci√≥n del entorno primero
      showEnvironmentInfo();
      
      await updateUI();
      
      // Escuchar cambios de permisos
      if ('permissions' in navigator) {
        try {
          const permissionStatus = await navigator.permissions.query({ name: 'notifications' });
          permissionStatus.onchange = updateUI;
        } catch (error) {
          console.log('No se pudo consultar el estado de permisos:', error);
        }
      }
    });
  </script>
{% endblock content %}
